#
# Сборка и упаковка фронтендов (miniapp + admin) в один nginx-образ.
# Цель: деплой одной командой `docker compose up -d` без ручного копирования dist.
#

FROM node:20-alpine AS build

WORKDIR /src

# --- Mini App ---
COPY apps/miniapp-web/package*.json /src/apps/miniapp-web/
RUN cd /src/apps/miniapp-web && npm ci
COPY apps/miniapp-web /src/apps/miniapp-web

# --- Admin Web ---
COPY apps/admin-web/package*.json /src/apps/admin-web/
RUN cd /src/apps/admin-web && npm ci
COPY apps/admin-web /src/apps/admin-web

# Build-time переменные для Vite (вшиваются в сборку).
# По умолчанию API ходит в /api (через nginx reverse proxy).
ARG VITE_API_URL=/api
ARG VITE_CONTACT_TELEGRAM_LINK=

RUN cd /src/apps/miniapp-web && VITE_API_URL="${VITE_API_URL}" VITE_CONTACT_TELEGRAM_LINK="${VITE_CONTACT_TELEGRAM_LINK}" npm run build
RUN cd /src/apps/admin-web && VITE_API_URL="${VITE_API_URL}" npm run build


FROM nginx:alpine AS runtime

# nginx-конфиг проекта
COPY infra/nginx.conf /etc/nginx/nginx.conf

# Статические сборки
COPY --from=build /src/apps/miniapp-web/dist/ /usr/share/nginx/html/miniapp/
COPY --from=build /src/apps/admin-web/dist/ /usr/share/nginx/html/admin/

EXPOSE 80

