# Docker Compose при использовании ВНЕШНЕЙ PostgreSQL.
# Порт 5432 занят — БД уже запущена на хосте.
#
# Перед запуском:
#   1. Создайте БД: CREATE DATABASE showcase;
#   2. Выполните миграции (локально или в контейнере)
#   3. Укажите DATABASE_URL
#
# Запуск:
#   export DATABASE_URL="postgresql+asyncpg://user:password@host:5432/showcase"
#   docker compose -f infra/docker-compose.external-db.yml up -d
#
# Или в одной строке:
#   DATABASE_URL="postgresql+asyncpg://user:password@host:5432/showcase" docker compose -f infra/docker-compose.external-db.yml up -d

services:
  api:
    # Для доступа к PostgreSQL на хосте с Linux: extra_hosts добавит host.docker.internal
    extra_hosts:
      - "host.docker.internal:host-gateway"
    build:
      context: ..
      dockerfile: infra/Dockerfile.api
    environment:
      DATABASE_URL: ${DATABASE_URL}
      JWT_SECRET: ${JWT_SECRET:-change-me}
      STORAGE_PATH: /app/storage
      CORS_ORIGINS: ${CORS_ORIGINS:-*}
      ADMIN_LOGIN: ${ADMIN_LOGIN:-admin}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin}
    volumes:
      - api_storage:/app/storage
    ports:
      - "${API_PORT:-8000}:8000"
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      # Соберите фронтенды: cd apps/miniapp-web && npm run build; cd apps/admin-web && npm run build
      - ../apps/miniapp-web/dist:/usr/share/nginx/html/miniapp:ro
      - ../apps/admin-web/dist:/usr/share/nginx/html/admin:ro
    depends_on:
      - api
    restart: unless-stopped

volumes:
  api_storage: {}
